<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Share - AnyDesk Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #lobby-view, #room-view, .modal-backdrop {
            display: none;
        }
        .user-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background-color: 0.2s;
        }
        .user-list-item:hover {
            background-color: #f1f5f9; /* slate-100 */
        }
        .chat-message-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .chat-message {
            padding: 6px 12px;
            border-radius: 1rem;
            max-width: 90%;
            word-wrap: break-word;
        }
        .chat-message.self {
            background-color: #0ea5e9; /* sky-500 */
            color: white;
            align-self: flex-end;
        }
        .chat-message.other {
            background-color: #e2e8f0; /* slate-200 */
            color: #1e293b; /* slate-800 */
            align-self: flex-start;
        }
        #remote-cursor {
            position: absolute;
            width: 24px;
            height: 24px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="rgba(255, 99, 71, 0.8)" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/></svg>');
            background-size: contain;
            pointer-events: none;
            transition: transform 0.1s;
        }
        #remote-cursor.clicking {
            transform: scale(0.8);
        }
        
        /* Toast Notification Styles */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }
        .toast {
            background-color: #2c3e50;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.215, 0.610, 0.355, 1.000);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { background-color: #27ae60; }
        .toast.error { background-color: #c0392b; }
        .toast.info { background-color: #2980b9; }

    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Lobby View -->
    <div id="lobby-view" class="w-full max-w-md text-center bg-white p-8 rounded-2xl shadow-xl">
        <h1 class="text-3xl font-bold mb-2">Screen Share</h1>
        <p class="text-slate-500 mb-8" id="lobby-subtitle">Create a room or join an existing one.</p>
        <div class="space-y-4">
            <input type="text" id="username-input" placeholder="Enter Your Name" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:outline-none">
            <button id="create-room-btn" class="btn w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg">Create New Room</button>
            <div class="flex items-center space-x-2">
                <input type="text" id="room-code-input" placeholder="Enter Room Code" class="flex-grow p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:outline-none">
                <button id="join-room-btn" class="btn bg-sky-500 hover:bg-sky-600 text-white font-bold p-3 rounded-lg">Join</button>
            </div>
        </div>
        <p id="lobby-error" class="text-red-500 mt-4 h-4"></p>
    </div>

    <!-- Room View -->
    <div id="room-view" class="w-full max-w-7xl h-[90vh] bg-white rounded-2xl shadow-xl flex flex-col md:flex-row overflow-hidden">
        <!-- Sidebar -->
        <div class="w-full md:w-80 bg-slate-50 border-r border-slate-200 p-4 flex flex-col flex-shrink-0">
            <h2 class="text-xl font-bold mb-2">Room Info</h2>
            <div class="mb-4">
                <p class="text-sm text-slate-500">Room Code:</p>
                <div class="flex items-center space-x-2">
                    <p id="room-code-display" class="font-mono bg-slate-200 text-slate-700 p-2 rounded-md text-center flex-grow">...</p>
                    <button id="share-link-btn" title="Copy Invite Link" class="btn bg-gray-300 hover:bg-gray-400 p-2 rounded-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    </button>
                </div>
            </div>
            <h3 class="text-lg font-bold mb-2 border-t pt-4">Users in Room</h3>
            <div id="user-list" class="overflow-y-auto space-y-2">
                <!-- User list will be populated here -->
            </div>
            
            <div class="mt-auto pt-4 border-t">
                <h3 class="text-lg font-bold mb-2">Chat</h3>
                <div id="chat-messages" class="overflow-y-auto space-y-2 bg-white p-2 rounded-md h-48 mb-2 border">
                    <!-- Messages will appear here -->
                </div>
                <div class="flex">
                    <input type="text" id="chat-input" placeholder="Type..." class="flex-grow p-2 border border-slate-300 rounded-l-lg focus:ring-2 focus:ring-sky-500 focus:outline-none text-sm">
                    <button id="send-chat-btn" class="btn bg-sky-500 hover:bg-sky-600 text-white font-bold p-2 rounded-r-lg text-sm flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
            </div>
            
            <button id="leave-room-btn" class="btn mt-4 w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg">Leave Room</button>
        </div>
        
        <!-- Main Content -->
        <div class="flex-grow p-4 flex items-center justify-center bg-slate-100 relative">
             <div id="video-placeholder" class="text-center text-slate-500">
                <h2 class="text-2xl font-semibold">Welcome!</h2>
                <p>Request to view a user's screen from the list on the left.</p>
            </div>
            <div class="video-container bg-black rounded-lg overflow-hidden w-full h-full border-4 border-slate-200 shadow-inner hidden relative">
                <video id="screen-video" class="w-full h-full" autoplay playsinline></video>
                <div id="remote-cursor" class="hidden"></div>
                <div id="viewer-controls" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black bg-opacity-50 text-white p-2 rounded-lg hidden flex-col items-center gap-2">
                    <div class="flex items-center gap-4">
                         <button id="request-control-btn" class="btn bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded">Request Control</button>
                         <span id="control-status" class="text-sm"></span>
                    </div>
                </div>
                 <button id="stop-sharing-btn" class="absolute bottom-4 left-1/2 -translate-x-1/2 btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg hidden flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
                    Stop Sharing
                </button>
                <button id="fullscreen-btn" class="absolute top-4 right-4 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 transition-opacity duration-300">
                    <svg id="expand-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
                    <svg id="compress-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 0-2-2h-3M3 16h3a2 2 0 0 0 2-2v-3"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="request-share-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
        <div class="bg-white rounded-lg p-8 shadow-xl text-center">
            <h2 class="text-xl font-bold mb-4">Screen Share Request</h2>
            <p class="mb-6">User <strong id="requester-share-info">...</strong> wants to view your screen.</p>
            <div class="space-x-4">
                <button id="accept-share-btn" class="btn bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-lg">Accept</button>
                <button id="reject-share-btn" class="btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Reject</button>
            </div>
        </div>
    </div>
    
    <div id="request-control-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
        <div class="bg-white rounded-lg p-8 shadow-xl text-center">
            <h2 class="text-xl font-bold mb-4">Remote Control Request</h2>
            <p class="mb-6">User <strong id="requester-control-info">...</strong> wants to control your screen pointer.</p>
            <div class="space-x-4">
                <button id="accept-control-btn" class="btn bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-lg">Accept</button>
                <button id="reject-control-btn" class="btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Reject</button>
            </div>
        </div>
    </div>


    <script>
        const socket = io();

        // Views and Modals
        const lobbyView = document.getElementById('lobby-view');
        const roomView = document.getElementById('room-view');
        const requestShareModal = document.getElementById('request-share-modal-backdrop');
        const requestControlModal = document.getElementById('request-control-modal-backdrop');

        // Lobby Elements
        const usernameInput = document.getElementById('username-input');
        const createRoomBtn = document.getElementById('create-room-btn');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const roomCodeInput = document.getElementById('room-code-input');
        const lobbyError = document.getElementById('lobby-error');
        const lobbySubtitle = document.getElementById('lobby-subtitle');

        // Room Elements
        const userList = document.getElementById('user-list');
        const roomCodeDisplay = document.getElementById('room-code-display');
        const shareLinkBtn = document.getElementById('share-link-btn');
        const videoContainer = document.querySelector('.video-container');
        const videoElement = document.getElementById('screen-video');
        const videoPlaceholder = document.getElementById('video-placeholder');
        const leaveRoomBtn = document.getElementById('leave-room-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const expandIcon = document.getElementById('expand-icon');
        const compressIcon = document.getElementById('compress-icon');
        const remoteCursor = document.getElementById('remote-cursor');
        const viewerControls = document.getElementById('viewer-controls');
        const requestControlBtn = document.getElementById('request-control-btn');
        const controlStatus = document.getElementById('control-status');
        const stopSharingBtn = document.getElementById('stop-sharing-btn');

        // Chat Elements
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');

        // Modal Elements
        const requesterShareInfo = document.getElementById('requester-share-info');
        const acceptShareBtn = document.getElementById('accept-share-btn');
        const rejectShareBtn = document.getElementById('reject-share-btn');
        const requesterControlInfo = document.getElementById('requester-control-info');
        const acceptControlBtn = document.getElementById('accept-control-btn');
        const rejectControlBtn = document.getElementById('reject-control-btn');

        // State
        let localStream;
        let peerConnections = {};
        let dataChannels = {};
        let myId = '';
        let myUsername = '';
        let currentRoom = '';
        let pendingShareRequesterId = null;
        let pendingControlRequesterId = null;
        let currentSharerId = null;
        let iAmControlling = false;

        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        
        // --- Init ---
        function handleUrlRoomCode() {
            const path = window.location.pathname;
            const parts = path.split('/');
            if (parts.length === 3 && parts[1] === 'room') {
                const roomCode = parts[2];
                roomCodeInput.value = roomCode;
                roomCodeInput.readOnly = true;
                lobbySubtitle.textContent = "You've been invited to a room. Enter your name to join.";
                createRoomBtn.style.display = 'none';
            }
        }

        window.onload = () => {
            lobbyView.style.display = 'block';
            handleUrlRoomCode();
        };

        // --- Toast Notification System ---
        const toastContainer = document.getElementById('toast-container');
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            
            // Animate in
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Animate out
            setTimeout(() => {
                toast.classList.remove('show');
                // Remove from DOM after animation
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        // --- Lobby Logic ---
        function handleLobbyAction(action) {
            const username = usernameInput.value.trim();
            if (!username) {
                lobbyError.textContent = 'Please enter your name.';
                return;
            }
            myUsername = username;
            lobbyError.textContent = '';
            const event = action === 'create' ? 'create-room' : 'join-room';
            const payload = action === 'create' ? { username } : { roomCode: roomCodeInput.value.trim(), username };
            if (action === 'join' && !payload.roomCode) {
                lobbyError.textContent = 'Please enter a room code.';
                return;
            }
            socket.emit(event, payload);
        }

        createRoomBtn.addEventListener('click', () => handleLobbyAction('create'));
        joinRoomBtn.addEventListener('click', () => handleLobbyAction('join'));
        leaveRoomBtn.addEventListener('click', () => window.location.href = '/');
        
        shareLinkBtn.addEventListener('click', () => {
            const shareUrl = `${window.location.origin}/room/${currentRoom}`;
            navigator.clipboard.writeText(shareUrl).then(() => {
                showToast('Invite link copied!', 'success');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy link.', 'error');
            });
        });
        
        fullscreenBtn.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                videoContainer.requestFullscreen().catch(err => showToast(`Fullscreen error: ${err.message}`, 'error'));
            } else {
                document.exitFullscreen();
            }
        });
        document.addEventListener('fullscreenchange', () => {
            const isFullscreen = !!document.fullscreenElement;
            expandIcon.classList.toggle('hidden', isFullscreen);
            compressIcon.classList.toggle('hidden', !isFullscreen);
        });

        // --- Stop Sharing Button ---
        stopSharingBtn.addEventListener('click', () => {
            console.log('[Action] Clicked Stop Sharing button.');
            if(localStream){
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            socket.emit('stop-sharing-notification');
            resetVideo();
        });


        // --- Socket Listeners ---
        socket.on('connect', () => { 
            myId = socket.id; 
            console.log(`%c[Socket] Connected to server with ID: ${myId}`, 'color: green; font-weight: bold;');
        });
        socket.on('room-created', (roomCode) => { 
            currentRoom = roomCode; 
            window.history.pushState({}, '', `/room/${roomCode}`);
            enterRoom(roomCode); 
        });
        socket.on('joined-room', (roomCode) => { currentRoom = roomCode; enterRoom(roomCode); });
        socket.on('join-error', (message) => { 
            lobbyError.textContent = message;
            roomCodeInput.readOnly = false;
        });
        socket.on('update-user-list', (users) => {
            console.log('%c--- User List Updated ---', 'color: blue; font-weight: bold;');
            console.table(users);
            updateUserList(users);
        });
        socket.on('user-joined', (user) => {
            console.log(`%c[Socket Event] User Joined: ${user.username} (${user.id})`, 'color: green;');
            showToast(`${user.username} has joined the room.`, 'info');
        });
        socket.on('user-left', (user) => {
            console.log(`%c[Socket Event] User Left: ${user.username} (${user.id})`, 'color: orange;');
            showToast(`${user.username} has left the room.`, 'info');
        });
        socket.on('sharer-started', ({ sharerId }) => {
            console.log(`%c[Socket Event] User ${sharerId} started sharing.`, 'color: cyan;');
            currentSharerId = sharerId;
            socket.emit('get-user-list', currentRoom); // Refresh user list to show icon
        });
        socket.on('share-request-received', ({ requesterId, requesterUsername }) => {
            console.log(`%c[Socket Event] Received share request from ${requesterUsername} (${requesterId})`, 'color: purple;');
            pendingShareRequesterId = requesterId;
            requesterShareInfo.textContent = requesterUsername;
            requestShareModal.style.display = 'flex';
        });
        socket.on('share-rejected', ({ rejecterUsername }) => {
            console.log(`%c[Socket Event] Share request rejected by ${rejecterUsername}`, 'color: red;');
            showToast(`Request to view ${rejecterUsername}'s screen was rejected.`, 'error');
        });
        socket.on('new-chat-message', (data) => addChatMessage(data));

        // Control Listeners
        socket.on('control-request-received', ({ requesterId, requesterUsername }) => {
            console.log(`%c[Socket Event] Received control request from ${requesterUsername} (${requesterId})`, 'color: purple;');
            pendingControlRequesterId = requesterId;
            requesterControlInfo.textContent = requesterUsername;
            requestControlModal.style.display = 'flex';
        });
        socket.on('control-accepted', ({targetId}) => {
            console.log(`%c[Socket Event] Control request accepted by ${targetId}`, 'color: green;');
            showToast('Control request accepted!', 'success');
            iAmControlling = true;
            controlStatus.textContent = "You have control.";
            requestControlBtn.disabled = true;
        });
        socket.on('control-rejected', ({ rejecterUsername }) => {
            console.log(`%c[Socket Event] Control request rejected by ${rejecterUsername}`, 'color: red;');
            showToast(`${rejecterUsername} rejected your control request.`, 'error');
            controlStatus.textContent = "";
        });

        // --- WebRTC Listeners ---
        socket.on('webrtc-offer', async ({ offer, fromId }) => {
            console.log(`%c[WebRTC] Received offer from ${fromId}`, 'color: teal;');
            currentSharerId = fromId;
            const pc = createPeerConnection(fromId);
            await pc.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            socket.emit('webrtc-answer', { answer, toId: fromId });
            console.log(`%c[WebRTC] Sent answer to ${fromId}`, 'color: teal;');
        });
        socket.on('webrtc-answer', async ({ answer, fromId }) => {
            console.log(`%c[WebRTC] Received answer from ${fromId}`, 'color: teal;');
            await peerConnections[fromId].setRemoteDescription(new RTCSessionDescription(answer));
        });
        socket.on('webrtc-candidate', ({ candidate, fromId }) => {
            // console.log(`%c[WebRTC] Received ICE candidate from ${fromId}`, 'color: gray;'); // Too noisy
            peerConnections[fromId].addIceCandidate(new RTCIceCandidate(candidate));
        });
        socket.on('share-stopped', () => {
            console.log('%c[Socket Event] Share stopped event received.', 'color: orange;');
            resetVideo();
        });

        // --- UI Functions ---
        function enterRoom(roomCode) {
            console.log(`Entering room: ${roomCode}`);
            lobbyView.style.display = 'none';
            roomView.style.display = 'flex';
            roomCodeDisplay.textContent = roomCode;
        }

        function updateUserList(users) {
            userList.innerHTML = '';
            users.forEach(user => {
                const isSharing = user.id === currentSharerId;
                const userElement = document.createElement('div');
                userElement.className = 'user-list-item';
                
                let userInfo = `<span class="font-semibold text-sm">${user.username}${user.id === myId ? ' (You)' : ''}</span>`;
                if(isSharing){
                    userInfo += `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-emerald-500 ml-2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>`;
                }
                userElement.innerHTML = `<div class="flex items-center">${userInfo}</div>`;

                if (user.id !== myId) {
                    const requestBtn = document.createElement('button');
                    requestBtn.textContent = 'View';
                    requestBtn.className = 'btn text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-1 px-2 rounded';
                    requestBtn.onclick = () => {
                        console.log(`[Action] Requesting to view screen of ${user.username} (${user.id})`);
                        socket.emit('request-share', { targetId: user.id });
                        showToast(`Request sent to ${user.username}`, 'info');
                    };
                    userElement.appendChild(requestBtn);
                }
                userList.appendChild(userElement);
            });
        }
        
        function resetVideo() {
            console.log('%c[State] Resetting video state.', 'color: red; font-weight: bold;');
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            Object.values(peerConnections).forEach(pc => pc.close());
            peerConnections = {};
            dataChannels = {};
            videoElement.srcObject = null;
            videoContainer.classList.add('hidden');
            viewerControls.classList.add('hidden');
            stopSharingBtn.classList.add('hidden');
            videoPlaceholder.classList.remove('hidden');
            videoPlaceholder.innerHTML = `<h2 class="text-2xl font-semibold">Welcome!</h2><p>Request to view a user's screen from the list on the left.</p>`;
            currentSharerId = null;
            iAmControlling = false;
            controlStatus.textContent = "";
            requestControlBtn.disabled = false;
        }

        // --- Chat Functions ---
        function addChatMessage({ username, message }) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message');
            if (username === 'System') {
                messageElement.classList.add('system');
                messageElement.textContent = message;
            } else {
                messageElement.innerHTML = username === myUsername ? `<span>${message}</span>` : `<strong>${username}: </strong><span>${message}</span>`;
                messageElement.classList.add(username === myUsername ? 'self' : 'other');
            }
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        function sendChatMessage() {
            const message = chatInput.value.trim();
            if (message) {
                socket.emit('send-chat-message', { message });
                chatInput.value = '';
            }
        }
        sendChatBtn.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatMessage(); });

        // --- Modal & Request Logic ---
        acceptShareBtn.addEventListener('click', async () => {
            console.log('[Action] Accepted share request from:', pendingShareRequesterId);
            requestShareModal.style.display = 'none';
            if (!pendingShareRequesterId) return;
            try {
                localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
                
                localStream.getVideoTracks()[0].onended = () => {
                    console.log('Sharing stopped via browser native UI.');
                    socket.emit('stop-sharing-notification');
                    resetVideo();
                };

                videoPlaceholder.classList.remove('hidden');
                videoContainer.classList.add('hidden');
                stopSharingBtn.classList.remove('hidden');
                videoPlaceholder.innerHTML = `<h2 class="text-2xl font-semibold text-emerald-600">You are sharing your screen.</h2>`;

                const pc = createPeerConnection(pendingShareRequesterId, localStream);
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                socket.emit('webrtc-offer', { offer, toId: pendingShareRequesterId, fromId: myId });
            } catch (err) { console.error("Screen capture error:", err); resetVideo(); }
            pendingShareRequesterId = null;
        });
        rejectShareBtn.addEventListener('click', () => {
            console.log('[Action] Rejected share request from:', pendingShareRequesterId);
            if (pendingShareRequesterId) socket.emit('reject-share', { requesterId: pendingShareRequesterId });
            requestShareModal.style.display = 'none';
            pendingShareRequesterId = null;
        });
        
        requestControlBtn.addEventListener('click', () => {
            console.log('[Action] Requesting control from:', currentSharerId);
             if(currentSharerId) {
                socket.emit('request-control', { targetId: currentSharerId });
                controlStatus.textContent = "Request sent...";
             }
        });
        acceptControlBtn.addEventListener('click', () => {
            console.log('[Action] Accepting control from:', pendingControlRequesterId);
            if(pendingControlRequesterId) socket.emit('accept-control', {requesterId: pendingControlRequesterId});
            requestControlModal.style.display = 'none';
            pendingControlRequesterId = null;
        });
        rejectControlBtn.addEventListener('click', () => {
            console.log('[Action] Rejecting control from:', pendingControlRequesterId);
            if(pendingControlRequesterId) socket.emit('reject-control', {requesterId: pendingControlRequesterId});
            requestControlModal.style.display = 'none';
            pendingControlRequesterId = null;
        });

        // --- WebRTC Core Logic ---
        function createPeerConnection(targetId, stream = null) {
            console.log(`%c[WebRTC] Creating peer connection to ${targetId}`, 'font-weight: bold;');
            const pc = new RTCPeerConnection(config);
            peerConnections[targetId] = pc;
            
            if (stream) { // Sharer's side
                stream.getTracks().forEach(track => pc.addTrack(track, stream));
                pc.ondatachannel = (event) => {
                    const dc = event.channel;
                    dataChannels[targetId] = dc;
                    dc.onmessage = (e) => handleControlMessage(JSON.parse(e.data));
                };
            } else { // Viewer's side
                pc.ontrack = (event) => {
                    console.log(`%c[WebRTC] Remote track received from ${targetId}`, 'color: green;');
                    videoPlaceholder.classList.add('hidden');
                    videoContainer.classList.remove('hidden');
                    viewerControls.classList.add('hidden');
                    videoElement.srcObject = event.streams[0];
                };
                const dc = pc.createDataChannel('controls');
                dataChannels[targetId] = dc;
            }
            
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('webrtc-candidate', { candidate: event.candidate, toId: targetId });
                }
            };
            pc.onconnectionstatechange = () => {
                console.log(`%c[WebRTC] Connection state with ${targetId}: ${pc.connectionState}`, 'color: blue;');
                if (pc.connectionState === 'connected') {
                    if (!stream) viewerControls.classList.remove('hidden');
                }
                if (['disconnected', 'closed', 'failed'].includes(pc.connectionState)) {
                    resetVideo();
                    socket.emit('stop-sharing-notification');
                }
            };
            return pc;
        }

        // --- Remote Control Logic ---
        function handleControlMessage({ type, x, y }) {
            remoteCursor.classList.remove('hidden');
            const videoRect = videoContainer.getBoundingClientRect();
            remoteCursor.style.left = `${x * videoRect.width}px`;
            remoteCursor.style.top = `${y * videoRect.height}px`;
            if (type === 'mousedown') remoteCursor.classList.add('clicking');
            if (type === 'mouseup') remoteCursor.classList.remove('clicking');
        }

        function sendControlEvent(e) {
            if (!iAmControlling || !dataChannels[currentSharerId] || dataChannels[currentSharerId].readyState !== 'open') {
                return;
            }
            // Uncomment the next line for extremely verbose mouse move logging
            // console.log(`Sending control data:`, { type: e.type });
            const rect = e.target.getBoundingClientRect();
            const x = (e.clientX - rect.left) / rect.width;
            const y = (e.clientY - rect.top) / rect.height;
            dataChannels[currentSharerId].send(JSON.stringify({ type: e.type, x, y }));
        }

        videoContainer.addEventListener('mousemove', sendControlEvent);
        videoContainer.addEventListener('mousedown', sendControlEvent);
        videoContainer.addEventListener('mouseup', sendControlEvent);
    </script>
</body>
</html>

